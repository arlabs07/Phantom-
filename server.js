const express=require('express');const{chromium}=require('playwright');const path=require('path');const app=express();const PORT=process.env.PORT||3000;let browser=null;let contexts=new Map();app.use(express.json());app.use(express.static('public'));async function initBrowser(){if(!browser){browser=await chromium.launch({headless:true,args:['--no-sandbox','--disable-setuid-sandbox','--disable-dev-shm-usage','--disable-accelerated-2d-canvas','--disable-gpu','--window-size=1920,1080']});console.log('ğŸŒ Headless browser initialized')}}async function getContext(sessionId){if(!contexts.has(sessionId)){await initBrowser();const context=await browser.newContext({viewport:{width:1920,height:1080},userAgent:'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',ignoreHTTPSErrors:true});contexts.set(sessionId,{context,pages:new Map(),createdAt:Date.now()});setTimeout(()=>{if(contexts.has(sessionId)){contexts.get(sessionId).context.close();contexts.delete(sessionId)}},30*60*1000)}return contexts.get(sessionId)}app.post('/api/navigate',async(req,res)=>{try{const{url,sessionId,tabId}=req.body;if(!url||!sessionId||!tabId)return res.status(400).json({error:'Missing parameters'});const session=await getContext(sessionId);let page=session.pages.get(tabId);if(!page){page=await session.context.newPage();session.pages.set(tabId,page);await page.setViewportSize({width:1920,height:1080})}const targetUrl=url.match(/^https?:\/\//)?url:url.includes('.')?`https://${url}`:`https://www.google.com/search?q=${encodeURIComponent(url)}`;await page.goto(targetUrl,{waitUntil:'networkidle',timeout:30000});const screenshot=await page.screenshot({type:'jpeg',quality:85});const title=await page.title();res.json({success:true,screenshot:screenshot.toString('base64'),title,url:page.url()})}catch(error){console.error('Navigate error:',error);res.status(500).json({error:error.message})}});app.post('/api/action',async(req,res)=>{try{const{action,sessionId,tabId,data}=req.body;const session=await getContext(sessionId);const page=session.pages.get(tabId);if(!page)return res.status(404).json({error:'Page not found'});let result={success:true};switch(action){case'click':await page.click(data.selector);break;case'type':await page.fill(data.selector,data.text);break;case'scroll':await page.evaluate(({x,y})=>window.scrollBy(x,y),data);break;case'back':await page.goBack();break;case'forward':await page.goForward();break;case'reload':await page.reload();break;case'screenshot':const screenshot=await page.screenshot({type:'jpeg',quality:85,fullPage:data.fullPage||false});result.screenshot=screenshot.toString('base64');break}const screenshot=await page.screenshot({type:'jpeg',quality:85});result.screenshot=screenshot.toString('base64');result.title=await page.title();result.url=page.url();res.json(result)}catch(error){console.error('Action error:',error);res.status(500).json({error:error.message})}});app.post('/api/close-tab',async(req,res)=>{try{const{sessionId,tabId}=req.body;const session=contexts.get(sessionId);if(session&&session.pages.has(tabId)){await session.pages.get(tabId).close();session.pages.delete(tabId);res.json({success:true})}else{res.status(404).json({error:'Tab not found'})}}catch(error){res.status(500).json({error:error.message})}});app.get('/api/health',async(req,res)=>{res.json({status:'healthy',browser:browser?'running':'stopped',sessions:contexts.size})});app.get('*',(req,res)=>{res.sendFile(path.join(__dirname,'public','index.html'))});process.on('SIGTERM',async()=>{console.log('Shutting down...');if(browser){await browser.close()}process.exit(0)});app.listen(PORT,async()=>{await initBrowser();console.log(`ğŸš€ Phantom VPN Browser running on port ${PORT}`);console.log(`ğŸ”’ All browsing happens server-side`);console.log(`ğŸŒ Uses cloud server IP for all requests`)});
