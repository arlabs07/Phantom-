<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Render Host & AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom scrollbar for code editor */
        textarea {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: scroll;
        }
        .chat-msg { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden">

    <!-- DESKTOP HEADER -->
    <header class="h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-server text-green-400"></i>
            <h1 class="font-bold text-lg">RenderHost<span class="text-xs font-normal text-gray-400 ml-2">Project Alpha</span></h1>
        </div>
        <div class="hidden md:flex gap-3">
            <button onclick="deployCode()" class="bg-green-600 hover:bg-green-700 px-4 py-1.5 rounded text-sm font-medium transition">
                <i class="fa-solid fa-cloud-arrow-up mr-2"></i>Deploy Real
            </button>
            <button onclick="requestScreenshot()" class="bg-blue-600 hover:bg-blue-700 px-4 py-1.5 rounded text-sm font-medium transition">
                <i class="fa-solid fa-camera mr-2"></i>Screenshot
            </button>
        </div>
        <!-- Mobile 3-dots Menu Button (visible only on mobile) -->
        <button onclick="toggleMobileMenu()" class="md:hidden text-gray-300 hover:text-white">
            <i class="fa-solid fa-ellipsis-vertical text-xl"></i>
        </button>
    </header>

    <!-- MAIN CONTENT AREA (Split View on Desktop, Tab View on Mobile) -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

        <!-- LEFT PANEL: ASSISTANT & CODE -->
        <div id="assistant-panel" class="w-full md:w-1/2 flex flex-col border-r border-gray-700 bg-gray-900 h-full">
            
            <!-- Chat Area -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900">
                <div class="chat-msg flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-robot"></i></div>
                    <div class="bg-gray-800 p-3 rounded-lg rounded-tl-none max-w-[80%] text-sm text-gray-200">
                        Hello! I am your AI Code Assistant (powered by Pollination). I can help you write code. Try asking "Create a landing page".
                    </div>
                </div>
            </div>

            <!-- Code Editor Tabs (Mini) -->
            <div class="flex bg-gray-800 text-xs border-y border-gray-700">
                <button onclick="switchEditor('html')" id="tab-html" class="px-4 py-2 bg-gray-700 text-blue-300 font-bold border-r border-gray-600">HTML</button>
                <button onclick="switchEditor('css')" id="tab-css" class="px-4 py-2 hover:bg-gray-700 text-gray-400 border-r border-gray-600">CSS</button>
                <button onclick="switchEditor('js')" id="tab-js" class="px-4 py-2 hover:bg-gray-700 text-gray-400">JS</button>
            </div>

            <!-- Editor Input -->
            <div class="h-64 md:h-96 relative group">
                <textarea id="code-html" class="w-full h-full bg-gray-950 p-4 text-sm text-blue-100 outline-none resize-none" placeholder="<!-- Write HTML here -->">
<div class="container">
    <h1>Hello World</h1>
    <p>Deployed via Render Node Server</p>
    <button id="clickMe">Click Me</button>
</div></textarea>
                <textarea id="code-css" class="w-full h-full bg-gray-950 p-4 text-sm text-pink-100 outline-none resize-none hidden" placeholder="/* Write CSS here */">
body { background: #111; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; }
.container { text-align: center; }
button { padding: 10px 20px; background: #3b82f6; border: none; color: white; border-radius: 5px; cursor: pointer; margin-top: 20px; }
button:hover { background: #2563eb; }</textarea>
                <textarea id="code-js" class="w-full h-full bg-gray-950 p-4 text-sm text-yellow-100 outline-none resize-none hidden" placeholder="// Write JS here">
document.getElementById('clickMe').addEventListener('click', () => {
    alert('Button Clicked!');
    console.log('Button was clicked at ' + new Date().toLocaleTimeString());
});</textarea>
            </div>

            <!-- Prompt Input -->
            <div class="p-3 bg-gray-800 border-t border-gray-700 flex gap-2">
                <input id="ai-prompt" type="text" placeholder="Ask AI to edit code..." class="flex-1 bg-gray-700 text-white px-3 py-2 rounded outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                <button onclick="askAI()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- RIGHT PANEL: PREVIEW -->
        <div id="preview-panel" class="w-full md:w-1/2 bg-white h-full relative hidden md:block">
            <div class="absolute top-0 left-0 w-full h-8 bg-gray-200 flex items-center px-2 justify-between border-b border-gray-300">
                <span class="text-xs text-gray-500 flex items-center gap-1"><i class="fa-solid fa-lock"></i> /site/index.html</span>
                <a href="/site/index.html" target="_blank" class="text-xs text-blue-600 hover:underline">Open in New Tab <i class="fa-solid fa-external-link-alt"></i></a>
            </div>
            <iframe id="preview-frame" class="w-full h-full pt-8" sandbox="allow-scripts allow-same-origin allow-modals"></iframe>
            
            <!-- Console Logs Overlay -->
            <div id="console-logs" class="absolute bottom-0 left-0 w-full max-h-40 bg-black/80 text-green-400 font-mono text-xs p-2 overflow-y-auto backdrop-blur-sm hidden">
                <div class="sticky top-0 bg-black/90 w-full flex justify-between border-b border-gray-700 mb-1 pb-1">
                    <span>Console Output</span>
                    <button onclick="document.getElementById('console-logs').classList.add('hidden')" class="text-red-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div id="log-content"></div>
            </div>
        </div>

    </main>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="md:hidden h-16 bg-gray-800 border-t border-gray-700 flex justify-around items-center shrink-0 z-20">
        <button onclick="switchTab('assistant')" class="flex flex-col items-center text-blue-400 active-tab-btn">
            <i class="fa-solid fa-code text-lg mb-1"></i>
            <span class="text-xs">Code</span>
        </button>
        <button onclick="switchTab('preview')" class="flex flex-col items-center text-gray-400">
            <i class="fa-solid fa-eye text-lg mb-1"></i>
            <span class="text-xs">Preview</span>
        </button>
        <button onclick="toggleMobileMenu()" class="flex flex-col items-center text-gray-400">
            <i class="fa-solid fa-ellipsis text-lg mb-1"></i>
            <span class="text-xs">More</span>
        </button>
    </nav>

    <!-- MOBILE MENU OVERLAY (3 DOTS) -->
    <div id="mobile-menu" class="fixed bottom-16 right-0 w-full bg-gray-800 border-t border-gray-700 transform translate-y-full transition-transform duration-200 z-10 md:hidden">
        <div class="p-4 grid grid-cols-2 gap-3">
            <button onclick="deployCode()" class="bg-green-600 p-3 rounded text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-rocket"></i> Deploy
            </button>
            <button onclick="requestScreenshot()" class="bg-blue-600 p-3 rounded text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-camera"></i> Screenshot
            </button>
            <button onclick="location.reload()" class="bg-gray-700 p-3 rounded text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-rotate-right"></i> Reload
            </button>
            <a href="/site/index.html" target="_blank" class="bg-gray-700 p-3 rounded text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-external-link-alt"></i> Open Site
            </a>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let currentTab = 'assistant'; // 'assistant' or 'preview'
        const iframe = document.getElementById('preview-frame');
        
        // --- UI FUNCTIONS ---

        function switchTab(tab) {
            currentTab = tab;
            const assistantPanel = document.getElementById('assistant-panel');
            const previewPanel = document.getElementById('preview-panel');
            
            // Reset mobile tab styles
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('text-blue-400', 'text-gray-400'));
            
            if (tab === 'assistant') {
                assistantPanel.classList.remove('hidden');
                previewPanel.classList.add('hidden');
                // On desktop, ensure both are visible, this logic mainly affects mobile due to CSS media queries
                if(window.innerWidth >= 768) previewPanel.classList.remove('hidden');
                
                document.querySelector('nav button:nth-child(1)').classList.add('text-blue-400');
                document.querySelector('nav button:nth-child(2)').classList.add('text-gray-400');
            } else {
                assistantPanel.classList.add('hidden');
                previewPanel.classList.remove('hidden');
                
                document.querySelector('nav button:nth-child(1)').classList.add('text-gray-400');
                document.querySelector('nav button:nth-child(2)').classList.add('text-blue-400');
                
                // Auto deploy/preview when switching to preview tab
                deployCode();
            }
        }

        function switchEditor(type) {
            ['html', 'css', 'js'].forEach(t => {
                document.getElementById(`code-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('bg-gray-700', 'text-blue-300');
                document.getElementById(`tab-${t}`).classList.add('text-gray-400');
            });
            document.getElementById(`code-${type}`).classList.remove('hidden');
            document.getElementById(`tab-${type}`).classList.add('bg-gray-700', 'text-blue-300');
            document.getElementById(`tab-${type}`).classList.remove('text-gray-400');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu.classList.contains('translate-y-full')) {
                menu.classList.remove('translate-y-full');
            } else {
                menu.classList.add('translate-y-full');
            }
        }

        // --- CORE FUNCTIONALITY ---

        function addChatMessage(role, text, isImage = false) {
            const history = document.getElementById('chat-history');
            const isAI = role === 'ai';
            const color = isAI ? 'bg-purple-600' : 'bg-blue-600';
            const align = isAI ? 'flex-row' : 'flex-row-reverse';
            const icon = isAI ? 'fa-robot' : 'fa-user';
            
            let contentHTML = '';
            if (isImage) {
                contentHTML = `<div class="bg-gray-800 p-2 rounded-lg max-w-[80%] border border-gray-600">
                    <p class="text-xs text-gray-400 mb-1">Screenshot received:</p>
                    <img src="${text}" class="rounded w-full h-auto border border-gray-700" />
                </div>`;
            } else {
                contentHTML = `<div class="bg-gray-800 p-3 rounded-lg ${isAI ? 'rounded-tl-none' : 'rounded-tr-none'} max-w-[80%] text-sm text-gray-200">
                    ${text}
                </div>`;
            }

            const html = `
                <div class="chat-msg flex gap-3 ${align}">
                    <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center shrink-0">
                        <i class="fa-solid ${icon}"></i>
                    </div>
                    ${contentHTML}
                </div>
            `;
            history.insertAdjacentHTML('beforeend', html);
            history.scrollTop = history.scrollHeight;
        }

        async function deployCode() {
            const html = document.getElementById('code-html').value;
            const css = document.getElementById('code-css').value;
            const js = document.getElementById('code-js').value;

            // Send to server
            try {
                const response = await fetch('/api/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html, css, js })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Refresh iframe with a cache-buster
                    iframe.src = data.url + '?t=' + new Date().getTime();
                    
                    // Show confirmation in console log area locally just for feedback
                    addChatMessage('ai', 'Code deployed successfully to server!');
                }
            } catch (e) {
                addChatMessage('ai', 'Error deploying code: ' + e.message);
            }
        }

        // --- AI INTEGRATION (POLLINATION) ---
        async function askAI() {
            const input = document.getElementById('ai-prompt');
            const prompt = input.value.trim();
            if (!prompt) return;

            addChatMessage('user', prompt);
            input.value = '';
            addChatMessage('ai', 'Thinking... <i class="fa-solid fa-spinner fa-spin"></i>');

            // Contextual Prompt Engineering
            const currentHTML = document.getElementById('code-html').value;
            const fullPrompt = `You are a web developer. The user wants: "${prompt}". 
            Current HTML: ${currentHTML.substring(0, 500)}... 
            Provide ONLY the raw HTML code inside the snippet to fix or create this. Do not include markdown or explanations.`;

            try {
                // Using Pollination Text API
                const url = `https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}`;
                const response = await fetch(url);
                const text = await response.text();

                // Remove loading message
                document.getElementById('chat-history').lastElementChild.remove();
                
                addChatMessage('ai', "Here is the code I generated. I've updated the HTML editor.");
                
                // Simple heuristic to update code (In a real app, use a better parser)
                if (text.includes('<') && text.includes('>')) {
                    document.getElementById('code-html').value = text;
                } else {
                    addChatMessage('ai', text);
                }

            } catch (err) {
                addChatMessage('ai', 'Error connecting to AI: ' + err.message);
            }
        }

        // --- CONSOLE LOG & SCREENSHOT HANDLING ---

        // Listen for messages from the iframe (Logs & Screenshots)
        window.addEventListener('message', (event) => {
            const data = event.data;

            if (data.type === 'console') {
                // Show in Logs UI
                const logsDiv = document.getElementById('console-logs');
                const logContent = document.getElementById('log-content');
                logsDiv.classList.remove('hidden');
                
                const logItem = document.createElement('div');
                logItem.className = `border-b border-gray-800 py-1 ${data.level === 'error' ? 'text-red-400' : 'text-green-400'}`;
                logItem.innerText = `> ${data.content}`;
                logContent.appendChild(logItem);
                logsDiv.scrollTop = logsDiv.scrollHeight;

            } else if (data.type === 'screenshot') {
                // Display screenshot in Chat
                addChatMessage('ai', data.image, true);
            }
        });

        function requestScreenshot() {
            if (!iframe.contentWindow) return;
            // Send message to iframe to trigger html2canvas
            iframe.contentWindow.postMessage({ action: 'takeScreenshot' }, '*');
        }

        // Initialize
        if(window.innerWidth >= 768) {
            deployCode(); // Auto deploy on load for desktop
        }
    </script>
</body>
</html>

